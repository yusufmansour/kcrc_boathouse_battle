<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>KCRC Boathouse Battle Scores</title>
  <link rel="icon" type="image/png" href="media/boathouse_battle_icon.png">
  <style>
    :root {
      /* Configuration variables */
      --num-teams: 4;
      --boat-height: 80px;
      --track-height: calc(var(--boat-height) * var(--num-teams) + 20px);
    }

    body {
      font-family: sans-serif;
      text-align: center;
      padding: 50px;
      background: #fafafa;
    }

    h1 {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    h1 img {
      height: 2em;
    }

    /* Race Track */
    .race-track {
      position: relative;
      width: 90%;
      max-width: 1400px;
      height: var(--track-height);
      margin: 30px auto;
      background: #f0f0f0;
      border: 3px solid #aaa;
      border-radius: 6px;
      overflow: visible;
    }

    .boat {
      position: absolute;
      height: var(--boat-height);
      width: 120px;
      transition: left 0.5s ease;
      z-index: 10;
    }

    .lane-divider {
      position: absolute;
      left: 0;
      width: 100%;
      height: 1px;
      border-top: 1px dashed #666;
    }

    .buoy {
      position: absolute;
      width: 10px;
      height: 10px;
      background: blue;
      border-radius: 50%;
    }

    .buoy-label {
      position: absolute;
      left: 12px;
      font-size: 12px;
      white-space: nowrap;
    }

    /* Team Display */
    .teams-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      max-width: 1400px;
      margin: 50px auto;
      padding: 0 20px;
    }

    .team-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .team-score {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .leaderboard h3 {
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    .leaderboard p {
      margin: 8px 0;
      font-size: 1.1em;
    }

    /* Week Buttons */
    .week-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin: 30px 0;
    }

    .week-button {
      padding: 15px 25px;
      font-size: 1.1em;
      border: 2px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      background: white;
      transition: all 0.2s ease;
      min-width: 120px;
      font-weight: 500;
    }

    .week-button:hover {
      background: #d0e4ff;
      border-color: #577aff;
      transform: translateY(-2px);
    }

    .week-button.active {
      background: #577aff;
      color: white;
      border-color: #577aff;
      font-weight: bold;
    }

    .week-button.winner {
      background: #ffd700;
      border-color: #daa520;
      font-weight: bold;
      color: white;
    }

    /* Countdown Timer */
    .countdown {
      margin: 50px auto;
      width: 90%;
      max-width: 800px;
      font-size: 8vw;
      font-weight: bold;
      background: #000525;
      color: #bb0000;
      padding: 40px 20px;
      border-radius: 20px;
      font-family: 'DigitalClock', 'Courier New', monospace;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    @media (min-width: 768px) {
      .countdown {
        font-size: 5em;
      }
    }

    .countdown .time {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .countdown .unit {
      font-size: 0.25em;
      color: white;
      margin-bottom: 5px;
    }

    @font-face {
      font-family: 'DigitalClock';
      src: url('media/digital-7.ttf') format('truetype');
    }

    /* Loading State */
    .loading {
      opacity: 0.5;
      pointer-events: none;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .teams-container {
        grid-template-columns: 1fr;
      }

      .team-score {
        font-size: 2rem;
      }

      .countdown {
        font-size: 12vw;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>
      <img src="media/boathouse_battle_icon.png" alt="Logo">
      <span>KCRC Boathouse Battle</span>
      <img src="media/boathouse_battle_icon.png" alt="Logo">
    </h1>
  </header>

  <!-- Race Track with Boats -->
  <div class="race-track" id="raceTrack"></div>

  <!-- Team Scores and Leaderboards -->
  <div class="teams-container" id="teamsContainer"></div>

  <!-- Week Selection Buttons -->
  <div class="week-buttons" id="weekButtons"></div>

  <!-- Countdown Timer (Week 4 only) -->
  <div class="countdown" id="countdown" style="display: none;">
    <div class="time">
      <span class="unit">HOURS</span>
      <span id="hours">00</span>
    </div>
    <div class="time">
      <span class="unit">MINUTES</span>
      <span id="minutes">00</span>
    </div>
    <div class="time">
      <span class="unit">SECONDS</span>
      <span id="seconds">00</span>
    </div>
  </div>

  <script>
    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    const CONFIG = {
      // Google Sheets CSV URL (update with your published sheet URL)
      spreadsheetUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHRRjnYLVSi8h2vrWZQAyyh3ssVh8_G19xZ_JP2gibUOKbsBDjfXhe6VGXXVnciVgSktVwazgiYPTF/pub?gid=1908909101&single=true&output=csv',
      
      // Competition end date
      endDate: new Date('March 1, 2026 20:00:00 GMT-0700'),
      
      // Week settings: course length and buoy spacing
      weekSettings: {
        1: { minCourse: 2000, buoySpacing: 250 },
        2: { minCourse: 2000, buoySpacing: 250 },
        3: { minCourse: 2000, buoySpacing: 250 },
        //4: { minCourse: 10000, buoySpacing: 1000 } // FINAL week
      },
      
      // Default week to display on load
      defaultWeek: 1,
      
      // Refresh interval in milliseconds
      refreshInterval: 15000,
      
      // Team configuration
      teams: [
        { name: 'Team Red', color: '#b70000', boatImage: 'media/rowing_shell_red.png' },
        { name: 'Team Green', color: '#167401', boatImage: 'media/rowing_shell_green.png' },
        { name: 'Team Blue', color: '#0066cc', boatImage: 'media/rowing_shell_blue.png' },
        { name: 'Team Purple', color: '#ff8800', boatImage: 'media/rowing_shell_purple.png' }
      ],
      
      // Manual week winners (set team name or null for auto-calculate from scores)
      // Team name must match exactly (case-insensitive) with teams array above
      manualWinners: {
        1: '',        // Week 1 winner
        2: '',      // Week 2 winner
        3: '',       // Week 3 winner
        4: ''               // Week 4 - null to auto-calculate
      }
    };

    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================
    let currentWeek = CONFIG.defaultWeek;
    let weekWinners = {}; // Populated from data or manual config
    let numWeeks = 4;
    let refreshIntervalId = null;

    // ============================================================================
    // COUNTDOWN TIMER
    // ============================================================================
    function updateCountdown() {
      const now = new Date();
      const diff = CONFIG.endDate - now;

      if (diff <= 0) {
        document.getElementById('hours').textContent = "00";
        document.getElementById('minutes').textContent = "00";
        document.getElementById('seconds').textContent = "00";
        return;
      }

      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      document.getElementById('hours').textContent = String(hours).padStart(2, '0');
      document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
      document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
    }

    function updateCountdownVisibility() {
      const countdown = document.getElementById('countdown');
      // Only show countdown during week 4
      countdown.style.display = currentWeek === 4 ? 'flex' : 'none';
    }

    // ============================================================================
    // DATA FETCHING AND PARSING
    // ============================================================================
    async function fetchScoresData() {
      // Add multiple cache-busting parameters to ensure fresh data
      const timestamp = new Date().getTime();
      const random = Math.random();
      const url = `${CONFIG.spreadsheetUrl}&_t=${timestamp}&_r=${random}`;
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      });
      
      const csvText = await response.text();
      return csvText.split('\n').map(row => 
        row.split(',').map(cell => cell.trim())
      );
    }

    function parseTeamScores(rows, week) {
      const teamData = [];
      const headers = rows[0];
      const totalsRow = rows[1];
      
      // First, initialize ALL teams from CONFIG (so they show even with no data)
      CONFIG.teams.forEach(team => {
        teamData.push({
          name: team.name,
          color: team.color,
          boatImage: team.boatImage,
          score: 0,
          topPlayers: []
        });
      });
      
      // Then update with actual data from sheets
      headers.forEach((header, colIndex) => {
        if (header.toLowerCase().includes('team:')) {
          const teamName = header.replace(/team:/i, '').trim();
          const teamIndex = teamData.findIndex(t => 
            t.name.toLowerCase() === teamName.toLowerCase()
          );
          
          if (teamIndex !== -1) {
            // Week score is at column offset 'week' from team name column
            const weekScore = parseInt(totalsRow[colIndex + week], 10) || 0;
            
            // Get individual player scores
            const players = [];
            for (let r = 3; r < rows.length; r++) {
              const playerName = rows[r][colIndex];
              const playerScore = parseInt(rows[r][colIndex + week], 10) || 0;
              if (playerName && playerScore > 0) {
                players.push({ name: playerName, score: playerScore });
              }
            }
            
            players.sort((a, b) => b.score - a.score);
            
            // Update the team data
            teamData[teamIndex].score = weekScore;
            teamData[teamIndex].topPlayers = players.slice(0, 3);
          }
        }
      });
      
      return teamData;
    }

    function determineWeekWinners(rows) {
      const winners = {};
      const headers = rows[0];
      const totalsRow = rows[1];
      
      // Determine number of weeks from headers
      const teamCols = headers.reduce((acc, h, i) => {
        if (h.toLowerCase().includes('team:')) acc.push(i);
        return acc;
      }, []);
      
      if (teamCols.length === 0) return winners;
      
      // Count weeks from first team section
      const firstTeamCol = teamCols[0];
      let weekCount = 0;
      for (let i = firstTeamCol + 1; i < headers.length; i++) {
        if (headers[i].toLowerCase().includes('week')) weekCount++;
        if (headers[i].toLowerCase().includes('total')) break;
      }
      
      numWeeks = weekCount;
      
      // Determine winners: use manual config if set, otherwise auto-calculate
      for (let w = 1; w <= weekCount; w++) {
        // Check if manual winner is configured
        if (CONFIG.manualWinners && CONFIG.manualWinners[w] !== undefined && CONFIG.manualWinners[w] !== null) {
          winners[w] = CONFIG.manualWinners[w];
        } else {
          // Auto-calculate from scores
          let maxScore = -1;
          let winningTeam = null;
          let isTie = false;
          
          teamCols.forEach(colIndex => {
            const teamName = headers[colIndex].replace(/team:/i, '').trim();
            const score = parseInt(totalsRow[colIndex + w], 10) || 0;
            
            if (score > maxScore) {
              maxScore = score;
              winningTeam = teamName;
              isTie = false;
            } else if (score === maxScore && score > 0) {
              isTie = true;
            }
          });
          
          winners[w] = isTie ? null : winningTeam;
        }
      }
      
      return winners;
    }

    function getTeamColor(teamName) {
      const team = CONFIG.teams.find(t => 
        t.name.toLowerCase() === teamName.toLowerCase()
      );
      return team ? team.color : '#666';
    }

    // ============================================================================
    // RACE TRACK RENDERING
    // ============================================================================
    function renderRaceTrack(teamData, week) {
      const track = document.getElementById('raceTrack');
      const trackWidth = track.offsetWidth;
      
      // Calculate course length
      const weekSetting = CONFIG.weekSettings[week] || { minCourse: 2000, buoySpacing: 250 };
      const maxScore = Math.max(...teamData.map(t => t.score), weekSetting.minCourse);
      const courseLength = Math.ceil(maxScore / weekSetting.buoySpacing) * weekSetting.buoySpacing;
      
      // Clear existing content
      track.innerHTML = '';
      
      // Update track height based on number of teams
      const laneHeight = 80;
      track.style.height = `${laneHeight * teamData.length + 20}px`;
      
      // Create lane dividers
      for (let i = 1; i < teamData.length; i++) {
        const divider = document.createElement('div');
        divider.className = 'lane-divider';
        divider.style.top = `${i * laneHeight}px`;
        track.appendChild(divider);
      }
      
      // Create buoys
      const buoyPositions = [];
      for (let d = 0; d <= courseLength; d += weekSetting.buoySpacing) {
        buoyPositions.push(d);
      }
      
      const maxPixels = trackWidth * 0.8;
      const startOffset = trackWidth * 0.1;
      
      buoyPositions.forEach((distance, i) => {
        const x = startOffset + (distance / courseLength) * maxPixels;
        
        // Top buoy
        const topBuoy = createBuoy(x, 5, distance, 'top');
        track.appendChild(topBuoy);
        
        // Bottom buoy
        const bottomBuoy = createBuoy(x, laneHeight * teamData.length + 5, distance, 'bottom');
        track.appendChild(bottomBuoy);
      });
      
      // Create boats - ALWAYS show boats even if score is 0
      teamData.forEach((team, index) => {
        const boat = document.createElement('img');
        boat.className = 'boat';
        boat.src = team.boatImage;
        boat.alt = `Team ${team.name}`;
        boat.style.top = `${index * laneHeight + 10}px`;
        
        const boatLength = Math.max(trackWidth * 0.08, 80);
        boat.style.width = `${boatLength}px`;
        
        // Position boat - if score is 0, show at starting line
        const boatPos = startOffset - boatLength + (team.score / courseLength) * maxPixels;
        boat.style.left = `${boatPos}px`;
        
        track.appendChild(boat);
      });
    }

    function createBuoy(x, y, distance, position) {
      const buoy = document.createElement('div');
      buoy.className = 'buoy';
      buoy.style.left = `${x}px`;
      buoy.style.top = `${y}px`;
      
      const label = document.createElement('div');
      label.className = 'buoy-label';
      label.textContent = distance;
      label.style.top = position === 'top' ? '-15px' : '15px';
      
      buoy.appendChild(label);
      return buoy;
    }

    // ============================================================================
    // TEAM DISPLAY RENDERING
    // ============================================================================
    function renderTeamsDisplay(teamData) {
      const container = document.getElementById('teamsContainer');
      container.innerHTML = '';
      
      teamData.forEach(team => {
        const section = document.createElement('div');
        section.className = 'team-section';
        
        const score = document.createElement('div');
        score.className = 'team-score';
        score.style.color = team.color;
        score.textContent = `${team.name}: ${team.score}`;
        
        const leaderboard = document.createElement('div');
        leaderboard.className = 'leaderboard';
        
        const title = document.createElement('h3');
        title.textContent = `${team.name} Leaderboard`;
        leaderboard.appendChild(title);
        
        const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
        
        if (team.topPlayers.length > 0) {
          team.topPlayers.forEach((player, index) => {
            const p = document.createElement('p');
            p.textContent = `${medals[index]} ${player.name}: ${player.score} points ${medals[index]}`;
            leaderboard.appendChild(p);
          });
        } else {
          const p = document.createElement('p');
          p.textContent = 'No scores yet';
          p.style.fontStyle = 'italic';
          p.style.color = '#999';
          leaderboard.appendChild(p);
        }
        
        section.appendChild(score);
        section.appendChild(leaderboard);
        container.appendChild(section);
      });
    }

    // ============================================================================
    // WEEK BUTTONS RENDERING
    // ============================================================================
    function renderWeekButtons() {
      const container = document.getElementById('weekButtons');
      container.innerHTML = '';
      
      for (let w = 1; w <= numWeeks; w++) {
        const button = document.createElement('button');
        button.className = 'week-button';
        button.id = `week${w}`;
        
        const winningTeam = weekWinners[w];
        const isFinal = w === numWeeks;
        
        if (winningTeam) {
          button.classList.add('winner');
          button.innerHTML = `ðŸ‘‘<br>${winningTeam}`;
          button.title = `Week ${w} - Winner: ${winningTeam}`;
          
          // Set winning team color
          const teamColor = getTeamColor(winningTeam);
          button.style.setProperty('--team-color', teamColor);
          
          // Add hover effect with team color
          button.addEventListener('mouseenter', function() {
            this.style.backgroundColor = teamColor;
            this.style.borderColor = teamColor;
          });
          
          button.addEventListener('mouseleave', function() {
            if (!this.classList.contains('active')) {
              this.style.backgroundColor = '#ffd700';
              this.style.borderColor = '#daa520';
            }
          });
        } else {
          button.textContent = isFinal ? `Week ${w}\nFINAL` : `Week ${w}`;
          button.title = `Week ${w}`;
        }
        
        if (w === currentWeek) {
          button.classList.add('active');
        }
        
        button.onclick = () => loadWeek(w);
        container.appendChild(button);
      }
    }

    // ============================================================================
    // MAIN DISPLAY LOGIC
    // ============================================================================
    async function loadWeek(week) {
      currentWeek = week;
      
      try {
        document.body.classList.add('loading');
        
        const rows = await fetchScoresData();
        const teamData = parseTeamScores(rows, week);
        weekWinners = determineWeekWinners(rows);
        
        renderRaceTrack(teamData, week);
        renderTeamsDisplay(teamData);
        renderWeekButtons();
        updateCountdownVisibility();
        
        document.body.classList.remove('loading');
      } catch (error) {
        console.error('Error loading scores:', error);
        document.body.classList.remove('loading');
      }
    }

    // ============================================================================
    // AUTO-REFRESH
    // ============================================================================
    function startAutoRefresh() {
      if (refreshIntervalId) {
        clearInterval(refreshIntervalId);
      }
      
      refreshIntervalId = setInterval(() => {
        loadWeek(currentWeek);
      }, CONFIG.refreshInterval);
    }

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    function init() {
      // Start countdown
      setInterval(updateCountdown, 1000);
      updateCountdown();
      
      // Load initial week
      loadWeek(CONFIG.defaultWeek);
      
      // Start auto-refresh
      startAutoRefresh();
    }

    // Start when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>

</html>
