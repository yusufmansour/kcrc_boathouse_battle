<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>KCRC Boathouse Battle Scores</title>
  <link rel="icon" type="image/png" href="media/boathouse_battle_icon.png">
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 50px;
    }

    .team {
      font-size: 2.5rem;
      /* Increase font size for scores */
      margin-bottom: 20px;
    }

    .active-week {
      background-color: rgb(87, 98, 255);
      font-weight: bold;
      color: white;
      /* Change text color to white */
    }

    button {
      font-size: 2em;
      /* Double the font size */
      padding: 20px;
      /* Increase padding for larger buttons */
    }

    .race-track {
      position: relative;
      width: 120%;
      /* Extend track by 20% before 0 and after 1000 */
      height: 150px;
      margin: 0 auto;
      /* Center the track */
      background: #f0f0f0;
      border: 3px solid #aaa;
      border-radius: 6px;
    }

    .boat {
      position: absolute;
      top: 10px;
      height: 80px;
      transition: left 0.5s ease;
    }

    #boat1 {
      top: 2px;
    }

    #boat2 {
      top: 77px;
    }

    .team-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      /* Center align vertically */
      margin-top: 50px;
    }

    .team-section {
      width: 45%;
      text-align: center;
      /* Center align text */
    }

    .leaderboard {
      text-align: center;
      /* Center align leaderboard players */
    }

    .week-button {
      text-align: center;
      transition: background-color 0.2s ease;
      white-space: normal;
      background-color: #f0f0f0;
      color: black;
      line-height: 1.2em;
      border: 1px solid #ccc;
      font-weight: normal;
      height: 3em;
      padding: 6px 12px;
      vertical-align: middle;
    }

    /* Default/undecided */
    .winner-undecided {
      background-color: #f0f0f0;
      color: black;
    }

    /* Port & Starboard winners */
    .winner-port {
      background-color: #b70000;
      color: white;
    }

    .winner-starboard {
      background-color: #167401;
      color: white;
    }

    /* Hover â€” all buttons turn light blue */
    .week-button:hover {
      background-color: #d0e4ff;
      /* light blue */
      color: black;
    }

    /* Selected (clicked/active) */
    .week-button.active-week {
      font-weight: bold;
      outline: 4px solid #577aff;
      /* subtle outline so it still pops */
    }

    @font-face {
      font-family: 'DigitalClock';
      src: url('media/digital-7.ttf') format('truetype');
    }

    .countdown {
      position: static;
      margin-top: 20px;
      width: 100%;
      font-size: 10em;
      font-weight: bold;
      background-color: black;
      color: rgb(187, 0, 0);
      padding: 20px 0;
      border-radius: 10px;
      font-family: 'DigitalClock', 'Courier New', Courier, monospace;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    .countdown .unit {
      font-size: 0.3em;
      color: white;
      display: block;
    }

    .countdown .time {
      display: inline-block;
      margin: 0 20px;
    }
  </style>
</head>

<body>
  <div>
    <h1>
      <img src="media/boathouse_battle_icon.png" alt="Logo" style="height: 2em;">
      KCRC Boathouse Battle
      <img src="media/boathouse_battle_icon.png" alt="Logo" style="height: 2em;">
    </h1>
  </div>
  <div class="race-track">
    <!-- Dotted line -->
    <div style="position: absolute; left: 0; top: 75px; width: 100%; height: 1px; border-top: 1px dashed black;"></div>

    <img id="boat1" class="boat" src="media/rowing_shell_red.png" alt="Team Port">
    <img id="boat2" class="boat" src="media/rowing_shell_green.png" alt="Team Starboard">
  </div>
  </div>

  <div class="team-container">
    <div class="team-section">
      <div id="team1" class="team">Team Port: Loading...</div>
      <div id="portTop3" class="leaderboard"></div>
    </div>
    <div class="team-section">
      <div id="team2" class="team">Team Starboard: Loading...</div>
      <div id="starboardTop3" class="leaderboard"></div>
    </div>
  </div>

  <div>
    <button id="week1" class="week-button" onclick="fetchScores(1)">Week 1</button>
    <button id="week2" class="week-button" onclick="fetchScores(2)">Week 2</button>
    <button id="week3" class="week-button" onclick="fetchScores(3)">Week 3</button>
    <button id="week5" class="week-button" onclick="fetchScores(5)">Week 4<br>FINAL</button>
  </div>
  <div id="winnerButtons" style="margin-top: 20px;"></div>

  <div class="countdown" id="countdown">
    <div class="time">
      <span class="unit">HOURS</span>
      <span id="hours">00</span>
    </div>
    <div class="time">
      <span class="unit">MINUTES</span>
      <span id="minutes">00</span>
    </div>
    <div class="time">
      <span class="unit">SECONDS</span>
      <span id="seconds">00</span>
    </div>
  </div>

  <script>
    function updateCountdown() {
      const targetDate = new Date('September 7, 2025 20:00:00 GMT-0700'); // Pacific Time
      const now = new Date();
      const diff = targetDate - now;

      if (diff <= 0) {
        document.getElementById('hours').textContent = "00";
        document.getElementById('minutes').textContent = "00";
        document.getElementById('seconds').textContent = "00";
        return;
      }

      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      document.getElementById('hours').textContent = String(hours).padStart(2, '0');
      document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
      document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
    }

    setInterval(updateCountdown, 1000);
    updateCountdown(); // Initialize immediately

    const winners = ['port', 'starboard', 'starboard', ''];
    // Per-week course configuration
    // weekNumber: { minCourse: meters, buoySpacing: meters }
    const weekSettings = {
      1: { minCourse: 2000, buoySpacing: 250 },
      2: { minCourse: 2000, buoySpacing: 250 },
      3: { minCourse: 2000, buoySpacing: 250 },
      5: { minCourse: 10000, buoySpacing: 1000 } // FINAL
    };
    const week = 5; // default week to load
    function jitterDigit(base) {
      // Random offset between -2 and +2, clamp between 0â€“9
      let digit = Math.floor((base % 100) / 10);
      const offset = Math.floor(Math.random() * 5) - 2;
      digit = Math.min(9, Math.max(0, digit + offset));
      return digit;
    }
    function highlightWeekButton(week) {
      // Remove active class from all week buttons
      document.querySelectorAll('button[id^="week"]').forEach(button => button.classList.remove('active-week'));
      // Add active class to the selected week button
      document.getElementById(`week${week}`).classList.add('active-week');
    }

    function updateWeekButtons(winners) {
      const buttons = document.querySelectorAll(".week-button");

      buttons.forEach((btn, index) => {
        const weekNum = index + 1;
        btn.classList.remove("winner-port", "winner-starboard", "winner-undecided");

        // Base text
        let winnerText = `Week ${weekNum}`;

        if (winners[weekNum - 1] === "port") {
          btn.classList.add("winner-port");
          winnerText = "ðŸ‘‘<br>Port"; // use <br> for line break
        } else if (winners[weekNum - 1] === "starboard") {
          btn.classList.add("winner-starboard");
          winnerText = "ðŸ‘‘<br>Starboard"; // line break
        } else {
          btn.classList.add("winner-undecided");
          winnerText = `Week ${weekNum}`;
          if (weekNum === 4) {
            winnerText = "Week 4<br>FINAL";
          }
        }

        // Set the data attributes for hover switching
        btn.dataset.weekLabel = `Week ${weekNum}`;   // text on hover
        if (weekNum === 4 && winners[weekNum - 1] === "") {
          btn.dataset.weekLabel = "Week 4<br>FINAL"; // keep FINAL on hover if undecided
        }
        btn.dataset.winnerLabel = winnerText;       // text normally

        // Initial text
        btn.innerHTML = winnerText;


        // Hover handlers
        btn.onmouseenter = () => { btn.innerHTML = btn.dataset.weekLabel; };
        btn.onmouseleave = () => { btn.innerHTML = btn.dataset.winnerLabel; };

        // Tooltip remains Week X
        btn.title = `Week ${weekNum}`;
        if (weekNum === 4) {
          btn.title = "Week 4<br>FINAL";
        }
      });

      equalizeButtonWidths();
    }


    function equalizeButtonWidths() {
      const buttons = document.querySelectorAll('.week-button');
      let maxWidth = 0;

      buttons.forEach(btn => {
        // Measure the button with its current content
        const width = btn.offsetWidth;
        if (width > maxWidth) maxWidth = width;
      });

      // Lock all buttons to maxWidth
      buttons.forEach(btn => {
        btn.style.width = `${maxWidth}px`;
      });
    }

    async function fetchScores(week) {
      highlightWeekButton(week);

      const baseUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHRRjnYLVSi8h2vrWZQAyyh3ssVh8_G19xZ_JP2gibUOKbsBDjfXhe6VGXXVnciVgSktVwazgiYPTF/pub?gid=1908909101&single=true&output=csv';
      const url = `${baseUrl}&_=${new Date().getTime()}`;
      const response = await fetch(url);
      const csvText = await response.text();
      const rows = csvText.split('\n').map(row => row.split(','));

      const portScore = parseInt(rows[1][week], 10);
      const starboardScore = parseInt(rows[1][week + 7], 10);
      let displayPort = portScore;
      let displayStarboard = starboardScore;
      let portRange = [portScore, portScore];
      let starboardRange = [starboardScore, starboardScore];


      document.getElementById('team1').textContent = `Team Port: ${displayPort}`;
      document.getElementById('team2').textContent = `Team Starboard: ${displayStarboard}`;
      const trackWidth = window.innerWidth * 0.9;
      document.querySelector('.race-track').style.width = `${trackWidth}px`;

      const boatLength = Math.max(trackWidth * 0.1, 80);
      document.getElementById('boat1').style.width = `${boatLength}px`;
      document.getElementById('boat2').style.width = `${boatLength}px`;


      // ðŸ‘‡ look up week settings (fallback if undefined)
      const { minCourse = 2000, buoySpacing = 250 } = weekSettings[week] || {};

      // max needed score or minCourse, whichever is larger
      const rawMax = Math.max(portScore, starboardScore, minCourse);

      // round up to nearest buoy spacing
      const courseLength = Math.ceil(rawMax / buoySpacing) * buoySpacing;

      // generate buoy distances dynamically
      const buoyDistances = [];
      for (let d = 0; d <= courseLength; d += buoySpacing) {
        buoyDistances.push(d);
      }


      const maxPixels = trackWidth * 0.8;
      const startOffset = trackWidth * 0.15;

      // scale buoy distances to pixels
      const scaledBuoyPositions = buoyDistances.map(
        d => startOffset + (d / courseLength) * maxPixels
      );

      function getBoatPixel(score, courseLength, maxPixels, startOffset, boatLength) {
        return startOffset - boatLength + (score / courseLength) * maxPixels;
      }

      let boat1Pos = getBoatPixel(portScore, courseLength, maxPixels, startOffset, boatLength);
      let boat2Pos = getBoatPixel(starboardScore, courseLength, maxPixels, startOffset, boatLength);



      document.getElementById('boat1').style.left = `${boat1Pos}px`;
      document.getElementById('boat2').style.left = `${boat2Pos}px`;


      // === NEW: regenerate buoys ===
      const raceTrack = document.querySelector('.race-track');

      // remove old buoys (but keep boats + dashed line)
      raceTrack.querySelectorAll('.buoy').forEach(b => b.remove());

      // create new buoys
      scaledBuoyPositions.forEach((x, i) => {
        // top buoy
        const top = document.createElement('div');
        top.className = 'buoy';
        top.style.position = 'absolute';
        top.style.left = `${x}px`;
        top.style.top = '0px';
        top.style.width = '10px';
        top.style.height = '10px';
        top.style.background = 'blue';
        top.style.borderRadius = '50%';

        // number label above
        const topLabel = document.createElement('div');
        topLabel.textContent = buoyDistances[i];
        topLabel.style.position = 'absolute';
        topLabel.style.left = '12px';
        topLabel.style.top = '-12px';
        topLabel.style.fontSize = '12px';
        top.appendChild(topLabel);

        raceTrack.appendChild(top);

        // bottom buoy
        const bottom = top.cloneNode(true);
        bottom.style.top = '137px';
        const bottomLabel = bottom.querySelector('div');
        bottomLabel.style.top = '12px'; // inside buoy
        raceTrack.appendChild(bottom);
      });

      // Extract top 3 players for Port
      let portPlayers = rows.slice(3).map(row => ({
        name: row[0],
        points: parseInt(row[week], 10) || 0
      })).filter(player => player.name).sort((a, b) => b.points - a.points).slice(0, 3);

      // Extract top 3 players for Starboard
      let starboardPlayers = rows.slice(3).map(row => ({
        name: row[7],
        points: parseInt(row[week + 7], 10) || 0
      })).filter(player => player.name).sort((a, b) => b.points - a.points).slice(0, 3);


      const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];

      // Display top 3 players for Port
      const portTop3 = document.getElementById('portTop3');
      portTop3.innerHTML = `<h3>Port Leaderboard</h3>` +
        portPlayers.map((player, index) => `<p>${medals[index]} ${player.name}: ${player.points} points ${medals[index]}</p>`).join('');

      // Display top 3 players for Starboard
      const starboardTop3 = document.getElementById('starboardTop3');
      starboardTop3.innerHTML = `<h3>Starboard Leaderboard</h3>` +
        starboardPlayers.map((player, index) => `<p>${medals[index]} ${player.name}: ${player.points} points ${medals[index]}</p>`).join('');
        if (week === 5) {
      const portBase = Math.floor(portScore / 100) * 100;
      const starBase = Math.floor(starboardScore / 100) * 100;

      const portHundreds = Math.floor(portBase / 100);
      const starHundreds = Math.floor(starBase / 100);

      function updateWeek5() {
        // --- Boats ---
        const portTens = jitterDigit(portBase);
        const starTens = jitterDigit(starBase);

        const displayPort = `${portHundreds}??`;
        const displayStarboard = `${starHundreds}??`;

        document.getElementById('team1').textContent = `Team Port: ${displayPort}`;
        document.getElementById('team2').textContent = `Team Starboard: ${displayStarboard}`;

        // --- Leaderboard jitter ---
        const portTop3Container = document.getElementById('portTop3');
        const starboardTop3Container = document.getElementById('starboardTop3');

        const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];

        const jitterPortPlayers = portPlayers.map(p => {
          const base = Math.floor(p.points / 100) * 100;
          const hundreds = Math.floor(base / 100);
          return { ...p, points: `${hundreds}??` };
        });

        const jitterStarboardPlayers = starboardPlayers.map(p => {
          const base = Math.floor(p.points / 100) * 100;
          const hundreds = Math.floor(base / 100);
          return { ...p, points: `${hundreds}??` };
        });

        portTop3Container.innerHTML = `<h3>Port Leaderboard</h3>` +
          jitterPortPlayers.map((player, index) =>
            `<p>${medals[index]} ${player.name}: ${player.points} points ${medals[index]}</p>`
          ).join('');

        starboardTop3Container.innerHTML = `<h3>Starboard Leaderboard</h3>` +
          jitterStarboardPlayers.map((player, index) =>
            `<p>${medals[index]} ${player.name}: ${player.points} points ${medals[index]}</p>`
          ).join('');
      }

      // Start or continue the 1-second loop
      updateWeek5();
      if (!window.week5Interval) {
        window.week5Interval = setInterval(updateWeek5, 3000);
      }
    }

      }

    // Default to Week 1 on page load
    fetchScores(week);
    updateWeekButtons(winners);

    // Rerun the query every 30 seconds
    setInterval(() => {
      const activeWeek = document.querySelector('.active-week')?.id.replace('week', '') || 1;
      fetchScores(parseInt(activeWeek, 10));
    }, 15000);
  </script>
</body>

</html>